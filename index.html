const params = new URLSearchParams(window.location.search);
const session_id = params.get("session_id");
if (!session_id) window.location.href = "https://deinehypnose.net";

// Polling-Loop: versuche mehrfach, stripe_url_kaufen abzuholen
let tries = 0;
const maxTries = 10;

function pollForStripeUrl() {
  fetch(`https://atzepeng.app.n8n.cloud/webhook/7ad19710-201a-453c-b503-4a20ec8647da?session_id=${session_id}`)
    .then(r => r.json())
    .then(d => {
      if (d.stripe_url_kaufen) {
        window.location.href = d.stripe_url_kaufen;
      } else if (tries < maxTries) {
        tries++;
        setTimeout(pollForStripeUrl, 500); // 500ms warten und nochmal versuchen
      } else {
        document.body.innerHTML = "<h1>Fehler beim Checkout-Redirect.</h1><p>Support: info@deinehypnose.net</p>";
      }
    })
    .catch(() => {
      if (tries < maxTries) {
        tries++;
        setTimeout(pollForStripeUrl, 500);
      } else {
        document.body.innerHTML = "<h1>Fehler beim Checkout-Redirect.</h1><p>Support: info@deinehypnose.net</p>";
      }
    });
}

pollForStripeUrl();
